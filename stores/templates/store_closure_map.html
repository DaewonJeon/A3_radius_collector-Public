<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>íì—… ë§¤ì¥ ì²´í¬ - ìˆ˜ì§‘ ë°ì´í„° ë·°ì–´</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Malgun Gothic', sans-serif;
            display: flex;
            height: 100vh;
        }

        /* ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ (boundary_viewer.html ì°¸ê³ ) */
        #sidebar {
            width: 280px;
            background: #1a1a2e;
            color: #fff;
            padding: 16px;
            overflow-y: auto;
            flex-shrink: 0;
        }

        #sidebar h2 {
            margin-bottom: 12px;
            color: #00d9ff;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .category-section {
            margin-bottom: 20px;
        }

        .category-title {
            color: #888;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 1px solid #333;
        }

        .filter-btn {
            width: 100%;
            padding: 10px 12px;
            margin: 4px 0;
            background: #16213e;
            border: none;
            color: #fff;
            cursor: pointer;
            border-radius: 6px;
            text-align: left;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }

        .filter-btn:hover {
            background: #0f3460;
            transform: translateX(3px);
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #00d9ff 0%, #0099cc 100%);
            color: #000;
            font-weight: 600;
        }

        .filter-btn .count {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
        }

        .filter-btn.active .count {
            background: rgba(0, 0, 0, 0.2);
        }

        .view-all-btn {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: #fff;
            cursor: pointer;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .view-all-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        /* ìƒíƒœ ë°°ì§€ */
        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            margin-left: 6px;
        }

        .status-badge.normal {
            background: #4ECDC4;
            color: #fff;
        }

        .status-badge.closed {
            background: #FF6B6B;
            color: #fff;
        }

        /* í†µê³„ ì •ë³´ */
        .stats-panel {
            background: #16213e;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
        }

        .stats-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .stats-row:last-child {
            margin-bottom: 0;
        }

        .stats-label {
            color: #888;
            font-size: 12px;
        }

        .stats-value {
            color: #00d9ff;
            font-weight: 600;
            font-size: 14px;
        }

        /* ë§µ ì˜ì—­ */
        #map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* ìš°ì¸¡ ìƒë‹¨ ì •ë³´ íŒ¨ë„ */
        .info-panel {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 100;
            max-width: 280px;
        }

        .info-panel h3 {
            font-size: 14px;
            color: #333;
            margin-bottom: 10px;
        }

        .legend {
            margin-top: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 13px;
            color: #555;
        }

        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            margin-right: 10px;
        }

        /* ì¸í¬ìœˆë„ìš° ìŠ¤íƒ€ì¼ */
        .iwContent {
            padding: 12px 16px;
            font-size: 13px;
            line-height: 1.5;
            min-width: 220px;
        }

        .iwContent .name {
            font-weight: bold;
            font-size: 14px;
            color: #333;
            margin-bottom: 6px;
        }

        .iwContent .address {
            color: #666;
            font-size: 12px;
            margin-bottom: 8px;
        }

        .iwContent .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .iwContent .status.normal {
            background: #E3F2FD;
            color: #1976D2;
        }

        .iwContent .status.closed {
            background: #FFEBEE;
            color: #D32F2F;
        }

        .iwContent .match-reason {
            margin-top: 8px;
            font-size: 11px;
            color: #888;
        }

        /* í˜„ì¬ í•„í„° í‘œì‹œ */
        .current-filter {
            background: rgba(0, 217, 255, 0.1);
            border: 1px solid #00d9ff;
            border-radius: 6px;
            padding: 8px 12px;
            margin-bottom: 16px;
            font-size: 12px;
            color: #00d9ff;
        }
    </style>
</head>

<body>
    <!-- ì‚¬ì´ë“œë°” -->
    <div id="sidebar">
        <h2>ğŸ—ºï¸ ìˆ˜ì§‘ ë°ì´í„° ë·°ì–´</h2>

        <!-- í†µê³„ íŒ¨ë„ -->
        <div class="stats-panel">
            <div class="stats-row">
                <span class="stats-label">ì „ì²´ ë°ì´í„°</span>
                <span class="stats-value" id="total-count">0</span>
            </div>
            <div class="stats-row">
                <span class="stats-label">ì •ìƒ ì˜ì—…</span>
                <span class="stats-value" style="color: #4ECDC4;">{{ normal_count }}ê°œ</span>
            </div>
            <div class="stats-row">
                <span class="stats-label">íì—… ì¶”ì •</span>
                <span class="stats-value" style="color: #FF6B6B;">{{ closed_count }}ê°œ</span>
            </div>
        </div>

        <!-- ì „ì²´ ë°ì´í„° ë³´ê¸° ë²„íŠ¼ -->
        <button class="view-all-btn" onclick="showAll()">
            ğŸ“‹ ì „ì²´ ë°ì´í„° ë³´ê¸°
        </button>

        <!-- í˜„ì¬ í•„í„° í‘œì‹œ -->
        <div class="current-filter" id="current-filter" style="display: none;">
            í•„í„°: <strong id="filter-text"></strong>
        </div>

        <!-- ìƒíƒœë³„ í•„í„° -->
        <div class="category-section">
            <div class="category-title">ğŸ“Š ìƒíƒœë³„ ë³´ê¸°</div>
            <button class="filter-btn" onclick="filterByStatus('ì •ìƒ')">
                <span>ğŸ”µ ì •ìƒ ì˜ì—…</span>
                <span class="count" id="count-normal">0</span>
            </button>
            <button class="filter-btn" onclick="filterByStatus('íì—…')">
                <span>ğŸ”´ íì—… ì¶”ì •</span>
                <span class="count" id="count-closed">0</span>
            </button>
        </div>

        <!-- ì§€ì—­ë³„ í•„í„° -->
        <div class="category-section">
            <div class="category-title">ğŸ™ï¸ ì§€ì—­ë³„ ë³´ê¸°</div>
            <div id="gu-list"></div>
        </div>
    </div>

    <!-- ë§µ ì»¨í…Œì´ë„ˆ -->
    <div id="map-container">
        <div id="map"></div>

        <!-- ì •ë³´ íŒ¨ë„ -->
        <div class="info-panel">
            <h3>ğŸ“ í‘œì‹œ ì¤‘ì¸ ë°ì´í„°</h3>
            <div id="display-info">ì „ì²´ ë°ì´í„°ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.</div>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #4285F4;"></div>
                    ì •ìƒ ì˜ì—…
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #EA4335;"></div>
                    íì—… ì¶”ì •
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_js_key }}"></script>

    <script>
        // Djangoì—ì„œ ì „ë‹¬ë°›ì€ ë°ì´í„°
        var allStores = JSON.parse('{{ stores_json|escapejs }}');
        var currentMarkers = [];
        var currentInfowindow = null;
        var map;

        // í†µê³„ ë°ì´í„° ê³„ì‚°
        var stats = {
            total: allStores.length,
            normal: allStores.filter(s => s.status === 'ì •ìƒ').length,
            closed: allStores.filter(s => s.status === 'íì—…').length,
            matchReasons: {},
            gus: {}
        };

        // ë§¤ì¹­ ì´ìœ ë³„ ì¹´ìš´íŠ¸
        allStores.forEach(function (store) {
            var reason = store.match_reason || 'ì•Œ ìˆ˜ ì—†ìŒ';
            stats.matchReasons[reason] = (stats.matchReasons[reason] || 0) + 1;

            // êµ¬ë³„ ì¹´ìš´íŠ¸ (ì¶”í›„ í™•ì¥ìš©)
            var gu = store.gu || 'ë¯¸ì§€ì •';
            stats.gus[gu] = (stats.gus[gu] || 0) + 1;
        });

        // í†µê³„ í‘œì‹œ
        document.getElementById('total-count').textContent = stats.total + 'ê°œ';
        document.getElementById('count-normal').textContent = stats.normal;
        document.getElementById('count-closed').textContent = stats.closed;

        // ì§€ì—­ë³„ ë²„íŠ¼ ìƒì„±
        var guList = document.getElementById('gu-list');
        var guKeys = Object.keys(stats.gus);
        guKeys.sort().forEach(function (gu) {
            var btn = document.createElement('button');
            btn.className = 'filter-btn';
            btn.innerHTML = '<span>ğŸ¢ ' + gu + '</span><span class="count">' + stats.gus[gu] + '</span>';
            btn.onclick = function () { filterByGu(gu); };
            guList.appendChild(btn);
        });

        // ì§€ë„ ì´ˆê¸°í™”
        var mapContainer = document.getElementById('map');
        var mapOption = {
            center: new kakao.maps.LatLng(37.5171, 126.9066),
            level: 5
        };
        map = new kakao.maps.Map(mapContainer, mapOption);

        // ì§€ë„ ì»¨íŠ¸ë¡¤ ì¶”ê°€
        var zoomControl = new kakao.maps.ZoomControl();
        map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);

        // ë§ˆì»¤ ìƒì„± í•¨ìˆ˜
        function createMarkers(stores) {
            // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
            clearMarkers();

            stores.forEach(function (store) {
                if (!store.lat || !store.lng) return;

                var markerPosition = new kakao.maps.LatLng(store.lat, store.lng);

                // ìƒíƒœë³„ ë§ˆì»¤ ì´ë¯¸ì§€ ì„¤ì •
                var markerColor = store.status === 'ì •ìƒ' ?
                    'https://t1.daumcdn.net/localimg/localimages/07/2018/pc/img/marker_spot.png' :
                    'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png';

                var imageSize = new kakao.maps.Size(36, 37);
                var imageOption = { offset: new kakao.maps.Point(13, 37) };
                var markerImage = new kakao.maps.MarkerImage(markerColor, imageSize, imageOption);

                var marker = new kakao.maps.Marker({
                    position: markerPosition,
                    title: store.name,
                    image: markerImage
                });

                marker.setMap(map);
                currentMarkers.push(marker);

                // ì¸í¬ìœˆë„ìš° ë‚´ìš©
                var statusClass = store.status === 'ì •ìƒ' ? 'normal' : 'closed';
                var statusText = store.status === 'ì •ìƒ' ? 'ğŸ”µ ì •ìƒ ì˜ì—…' : 'ğŸ”´ íì—… ì¶”ì •';

                var iwContent = '<div class="iwContent">' +
                    '<div class="name">' + store.name + '</div>' +
                    '<div class="address">' + store.address + '</div>' +
                    '<div class="status ' + statusClass + '">' + statusText + '</div>' +
                    '<div class="match-reason">ë§¤ì¹­: ' + store.match_reason + '</div>' +
                    '</div>';

                var infowindow = new kakao.maps.InfoWindow({
                    content: iwContent,
                    removable: true
                });

                // í´ë¦­ ì´ë²¤íŠ¸
                kakao.maps.event.addListener(marker, 'click', function () {
                    if (currentInfowindow) {
                        currentInfowindow.close();
                    }
                    infowindow.open(map, marker);
                    currentInfowindow = infowindow;
                });
            });

            // ë§ˆì»¤ì— ë§ê²Œ ì§€ë„ ë²”ìœ„ ì¡°ì •
            if (stores.length > 0) {
                var bounds = new kakao.maps.LatLngBounds();
                stores.forEach(function (store) {
                    if (store.lat && store.lng) {
                        bounds.extend(new kakao.maps.LatLng(store.lat, store.lng));
                    }
                });
                map.setBounds(bounds);
            }
        }

        // ë§ˆì»¤ ì œê±° í•¨ìˆ˜
        function clearMarkers() {
            currentMarkers.forEach(function (marker) {
                marker.setMap(null);
            });
            currentMarkers = [];
            if (currentInfowindow) {
                currentInfowindow.close();
                currentInfowindow = null;
            }
        }

        // í•„í„° ë²„íŠ¼ í™œì„±í™” í•¨ìˆ˜
        function setActiveButton(activeBtn) {
            document.querySelectorAll('.filter-btn').forEach(function (btn) {
                btn.classList.remove('active');
            });
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
        }

        // í•„í„° í‘œì‹œ í•¨ìˆ˜
        function showFilterInfo(text) {
            var filterDiv = document.getElementById('current-filter');
            var filterText = document.getElementById('filter-text');
            if (text) {
                filterDiv.style.display = 'block';
                filterText.textContent = text;
            } else {
                filterDiv.style.display = 'none';
            }
        }

        // ì „ì²´ ë³´ê¸°
        function showAll() {
            setActiveButton(null);
            showFilterInfo(null);
            document.getElementById('display-info').textContent = 'ì „ì²´ ë°ì´í„° ' + allStores.length + 'ê°œë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.';
            createMarkers(allStores);
        }

        // ìƒíƒœë³„ í•„í„°
        function filterByStatus(status) {
            var filtered = allStores.filter(function (s) { return s.status === status; });
            var statusText = status === 'ì •ìƒ' ? 'ğŸ”µ ì •ìƒ ì˜ì—…' : 'ğŸ”´ íì—… ì¶”ì •';

            event.target.closest('.filter-btn').classList.add('active');
            setActiveButton(event.target.closest('.filter-btn'));
            showFilterInfo(statusText);
            document.getElementById('display-info').textContent = statusText + ' ' + filtered.length + 'ê°œë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.';
            createMarkers(filtered);
        }

        // ë§¤ì¹­ ì´ìœ ë³„ í•„í„°
        function filterByMatchReason(reason) {
            var filtered = allStores.filter(function (s) { return s.match_reason === reason; });

            setActiveButton(event.target.closest('.filter-btn'));
            showFilterInfo(reason);
            document.getElementById('display-info').textContent = 'ë§¤ì¹­ ì´ìœ : ' + reason + ' (' + filtered.length + 'ê°œ)';
            createMarkers(filtered);
        }

        // êµ¬ë³„ í•„í„°
        function filterByGu(gu) {
            var filtered = allStores.filter(function (s) { return s.gu === gu; });

            setActiveButton(event.target.closest('.filter-btn'));
            showFilterInfo(gu);
            document.getElementById('display-info').textContent = gu + ' ë°ì´í„° ' + filtered.length + 'ê°œë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.';
            createMarkers(filtered);
        }

        // ì´ˆê¸° ë¡œë“œ: ì „ì²´ ë°ì´í„° í‘œì‹œ
        showAll();
    </script>

</body>

</html>